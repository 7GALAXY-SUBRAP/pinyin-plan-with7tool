<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô Pinyin ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #118AB2;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="container mx-auto max-w-5xl">
    
    <!-- AI LANGUAGE STUDY HELPER SECTION -->
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg mb-12 border-4 border-indigo-200">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô</h1>
        <p class="text-gray-600 mb-6">‡∏õ‡πâ‡∏≠‡∏ô Hanzi ‡∏´‡∏£‡∏∑‡∏≠ Pinyin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô</p>

        <textarea id="textInput" rows="3" 
                  class="w-full p-4 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 text-lg"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‰Ω†Â•Ω (n«ê h«éo) ‡∏´‡∏£‡∏∑‡∏≠ Ê±âËØ≠ (h√†ny«î)"></textarea>
        
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <button id="explainButton" 
                    class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50"
                    onclick="handleExplanation()">
                ‚ú® ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Get Detailed Explanation)
            </button>
            <button id="ttsButton" 
                    class="flex-1 px-6 py-3 bg-teal-600 text-white font-semibold rounded-xl hover:bg-teal-700 transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50"
                    onclick="handleTTS()">
                üéß ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Read Text Aloud)
            </button>
        </div>

        <div id="loadingIndicator" class="text-center my-4 hidden">
            <div class="loading-spinner inline-block"></div>
            <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÇ‡∏î‡∏¢ Gemini...</p>
        </div>

        <!-- Explanation Output Area (Text Generation) -->
        <div id="explanationOutput" class="mt-8 p-6 bg-indigo-50 border border-indigo-300 rounded-xl hidden">
            <h2 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏à‡∏≤‡∏Å AI</h2>
            <div id="aiTextContent" class="text-gray-700 whitespace-pre-wrap"></div>
            <div id="sources" class="mt-4 text-xs text-gray-500"></div>
        </div>

        <!-- TTS Output Area (Audio Playback) -->
        <div id="ttsOutput" class="mt-8 p-6 bg-teal-50 border border-teal-300 rounded-xl hidden">
            <h2 class="text-xl font-bold text-teal-700 mb-3 border-b pb-2">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h2>
            <audio id="audioPlayer" controls class="w-full"></audio>
        </div>
    </div>
    
    <!-- ORIGINAL DASHBOARD CONTENT SECTION -->
    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-800 border-b pb-3 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô Pinyin 7 ‡∏ß‡∏±‡∏ô</h1>
        <p class="text-xl text-gray-500">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </header>

    <div class="grid md:grid-cols-2 gap-8">
        
        <!-- Chart 1: Daily Study Time -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-bold text-blue-700 mb-4">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)</h2>
            <div class="chart-container">
                <canvas id="studyTimeChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Vocabulary Growth -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-bold text-green-700 mb-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏∞‡∏™‡∏°</h2>
            <div class="chart-container">
                <canvas id="vocabGrowthChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Learning Summary -->
    <div class="mt-12 p-8 bg-blue-50 rounded-xl shadow-inner border border-blue-200">
        <h2 class="text-2xl font-bold text-blue-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 1</h2>
        <ul class="list-disc list-inside space-y-2 text-gray-700">
            <li>‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <span class="font-bold text-indigo-600">25 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</span> ‡∏ã‡∏∂‡πà‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ!</li>
            <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° <span class="font-bold text-indigo-600">33 ‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏ß‡∏•‡∏µ</span></li>
            <li>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞ <span class="font-bold text-indigo-600">zh, ch, sh, r</span> ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ AI Helper ‡∏ù‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</li>
            <li>‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô: <span class="font-bold">xƒ´guƒÅ (Ë•øÁìú) ‡πÅ‡∏•‡∏∞ fƒìich√°ng (ÈùûÂ∏∏)</span></li>
        </ul>
    </div>

</div>

<script>
    // --- Configuration and Utilities for AI Helper ---
    const apiKey = ""; // API key for Gemini API
    const textInput = document.getElementById('textInput');
    const explainButton = document.getElementById('explainButton');
    const ttsButton = document.getElementById('ttsButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const explanationOutput = document.getElementById('explanationOutput');
    const aiTextContent = document.getElementById('aiTextContent');
    const sourcesDiv = document.getElementById('sources');
    const ttsOutput = document.getElementById('ttsOutput');
    const audioPlayer = document.getElementById('audioPlayer');

    /**
     * Simple exponential backoff retry logic for API calls.
     */
    async function fetchWithRetry(url, options, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}. Details: ${errorText}`);
                }
                return response;
            } catch (error) {
                console.error(`Attempt ${i + 1} failed: ${error.message}`);
                if (i === maxRetries - 1) throw error;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    // --- TTS Helper Functions ---

    /**
     * Converts a Base64 string to an ArrayBuffer.
     */
    const base64ToArrayBuffer = (base64) => {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    };

    /**
     * Converts signed 16-bit PCM audio data to a WAV format Blob.
     * FIX: Uses the correct offset calculation for WAV header.
     */
    const pcmToWav = (pcm16, sampleRate) => {
        const numChannels = 1;
        const bitsPerSample = 16;
        const bytesPerSample = bitsPerSample / 8;
        const blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = pcm16.length * bytesPerSample;

        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        let offset = 0;

        /* Utility function to write a string */
        function writeString(s) {
            for (let i = 0; i < s.length; i++) {
                view.setUint8(offset + i, s.charCodeAt(i));
            }
            offset += s.length;
        }

        // RIFF chunk (0-11)
        writeString('RIFF'); 
        view.setUint32(offset, 36 + dataSize, true); offset += 4; // File size (4-7)
        writeString('WAVE'); 
        
        // FMT chunk (20-35)
        writeString('fmt '); 
        view.setUint32(offset, 16, true); offset += 4; // Chunk size (16 for PCM)
        view.setUint16(offset, 1, true); offset += 2; // Audio Format (PCM = 1)
        view.setUint16(offset, numChannels, true); offset += 2; // Channels
        view.setUint32(offset, sampleRate, true); offset += 4; // Sample rate
        view.setUint32(offset, byteRate, true); offset += 4; // Byte rate
        view.setUint16(offset, blockAlign, true); offset += 2; // Block align
        view.setUint16(offset, bitsPerSample, true); offset += 2; // Bits per sample

        // DATA chunk (44+)
        writeString('data'); 
        view.setUint32(offset, dataSize, true); offset += 4; // Data size

        /* Write PCM samples */
        const pcmDataOffset = 44; 
        new Uint8Array(buffer, pcmDataOffset).set(new Uint8Array(pcm16.buffer));
        
        return new Blob([buffer], { type: 'audio/wav' });
    };


    // --- Gemini LLM Feature 1: Detailed Explanation (Text Generation with Grounding) ---

    async function handleExplanation() {
        const userQuery = textInput.value.trim();
        if (!userQuery) return;

        // Reset previous outputs
        explanationOutput.classList.add('hidden');
        ttsOutput.classList.add('hidden');
        aiTextContent.textContent = '';
        sourcesDiv.textContent = '';
        
        explainButton.disabled = true;
        ttsButton.disabled = true;
        loadingIndicator.classList.remove('hidden');

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const systemPrompt = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡πà‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏•‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢, ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏¥‡∏ô‡∏≠‡∏¥‡∏ô), ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Google Search ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

        const payload = {
            contents: [{ parts: [{ text: `‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏•‡∏µ "${userQuery}" ‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢` }] }],
            tools: [{ "google_search": {} }], // Enable Google Search grounding
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                aiTextContent.textContent = text;
                
                // Extract grounding sources
                let sourcesHtml = '';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const validSources = groundingMetadata.groundingAttributions
                        .map(attr => ({
                            uri: attr.web?.uri,
                            title: attr.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (validSources.length > 0) {
                        sourcesHtml = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ';
                        validSources.forEach((source, index) => {
                            sourcesHtml += `<a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700">${source.title}</a>${index < validSources.length - 1 ? ', ' : ''}`;
                        });
                    }
                }
                sourcesDiv.innerHTML = sourcesHtml;
                explanationOutput.classList.remove('hidden');

            } else {
                aiTextContent.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                explanationOutput.classList.remove('hidden');
            }

        } catch (error) {
            console.error('Gemini Explanation Error:', error);
            aiTextContent.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI: ${error.message}`;
            explanationOutput.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
            explainButton.disabled = false;
            ttsButton.disabled = false;
        }
    }


    // --- Gemini LLM Feature 2: Read Text Aloud (TTS Generation) ---
    
    async function handleTTS() {
        const textToSpeak = textInput.value.trim();
        if (!textToSpeak) return;

        // Reset previous outputs
        explanationOutput.classList.add('hidden');
        ttsOutput.classList.add('hidden');
        audioPlayer.src = '';

        explainButton.disabled = true;
        ttsButton.disabled = true;
        loadingIndicator.classList.remove('hidden');
        
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: textToSpeak }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: "Kore" } // Using Kore for clear Mandarin
                    }
                }
            },
            model: "gemini-2.5-flash-preview-tts"
        };

        try {
            const response = await fetchWithRetry(ttsApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 

                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                audioPlayer.src = audioUrl;
                ttsOutput.classList.remove('hidden');
                audioPlayer.play();

            } else {
                 console.error('TTS response error:', result);
                 // Using custom modal/message box is preferred in prod
                 alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'); 
            }

        } catch (error) {
            console.error('Gemini TTS Error:', error);
            // Using custom modal/message box is preferred in prod
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${error.message}`); 
        } finally {
            loadingIndicator.classList.add('hidden');
            explainButton.disabled = false;
            ttsButton.disabled = false;
        }
    }


    // --- Chart Initialization (Original Functionality) ---
    document.addEventListener('DOMContentLoaded', (event) => {
        const vibrantColors = {
            blue: '#3b82f6',
            indigo: '#6366f1',
            green: '#10b981',
            yellow: '#f59e0b'
        };

        const tooltipTitleCallback = {
             plugins: {
                tooltip: {
                    callbacks: {
                        title: (tooltipItem) => {
                            // Returns the label directly for both charts
                            return tooltipItem[0].label;
                        }
                    }
                }
            }
        };


        // Chart 1: Daily Study Time
        const studyTimeCtx = document.getElementById('studyTimeChart').getContext('2d');
        new Chart(studyTimeCtx, {
            type: 'line',
            data: {
                labels: ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7'],
                datasets: [{
                    label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)',
                    data: [20, 30, 25, 45, 15, 30, 20],
                    borderColor: vibrantColors.blue,
                    backgroundColor: vibrantColors.blue + '40', // Semi-transparent
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                 ...tooltipTitleCallback,
                 scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '‡∏ô‡∏≤‡∏ó‡∏µ'
                        }
                    }
                }
            }
        });

        // Chart 2: Vocabulary Growth
        const vocabGrowthCtx = document.getElementById('vocabGrowthChart').getContext('2d');
        new Chart(vocabGrowthCtx, {
            type: 'bar',
            data: {
                labels: ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7'],
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏∞‡∏™‡∏°',
                    data: [3, 6, 9, 14, 28, 33, 33],
                    backgroundColor: vibrantColors.green,
                    borderColor: vibrantColors.green,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                 ...tooltipTitleCallback,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏ß‡∏•‡∏µ'
                        }
                    }
                }
            }
        });
    });
</script>

</body>
</html>
